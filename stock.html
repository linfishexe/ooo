<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./scripts/ChartCanvas.js"></script>
    <script src="./scripts/StockDataProcessor.js"></script>
    <script src="./scripts/StockListUI.js"></script>
    <link rel="stylesheet" href="styles/style.css">
    <title>股價 csv 讀取</title>
</head>
<body>
    <!-- 初始提示與選檔案 -->
    <section id="uploadSection">
        <h2>請選擇要載入的走勢CSV</h2>
        <img src="./upload.svg" alt="uploadCSV">
        <div class="btnBox">
            <button id="loadDefaultBtn">載入預設 CSV</button>
            <label for="csvFile">上傳自己的 CSV</label>
            <input type="file" id="csvFile" accept=".csv" style="display: none;"/>
        </div>
    </section>

    <nav>
        <button onclick="toggleAside(this)" class="menuBtn" aria-label="Toggle Aside Menu">
            <div></div>
            <div></div>
            <div></div>
        </button>
    </nav>
    <main>
        <section id="chartsContainer"><!-- 圖表容器 --></section>
        <aside>
            <h2>股票列表</h2>
            <ul class="stock_list"></ul>
        </aside>
    </main>
<script>
function toggleAside(button) {
    const aside = document.querySelector("aside");
    button.classList.toggle("open");
    aside.classList.toggle("open");
}
</script>
<script>
const stockList = document.querySelector("aside .stock_list");

const chartCanvas = new ChartCanvas(chartsContainer);
const stockDataProcessor = new StockDataProcessor();
const stockListUI = new StockListUI(stockList, showChartsByIndices);

document.getElementById("csvFile").addEventListener("change", function (event) {
    const file = event.target.files[0];
    if (!file) return;
    Papa.parse(file, { complete: completeParse });
});

document.getElementById("loadDefaultBtn").addEventListener("click", function () {
    const url = "https://linfishexe.github.io/ooo/20210501-20210531.csv";
    fetch(url)
        .then(response => response.text())
        .then(csvText => { Papa.parse(csvText, { complete: completeParse }); })
        .catch(err => console.error("載入預設 CSV 失敗:", err));
});

function completeParse(results) {
    stockDataProcessor.parse(results);
    stockListUI.render(stockDataProcessor.stockNames);
    document.getElementById("uploadSection").style.display = "none";
}

// 繪製 購買勾選股票的後的資金水位
function showChartsByIndices(indices) {
    const INITIAL_CAPITAL = 10000000;             // 資金 1,000 萬元
    const stockAmount = indices.length;             // 股票檔數
    let portfolioValues = []; // 用來記錄每日資金水位的容器
    let labels = []; // 對應的 X 軸標籤 (Day1, Day2, ...)

    // 如果有勾選至少一檔股票
    if ( stockAmount > 0 ) {

        // 計算每檔股票的平均分配資金
        const capital = Math.floor(INITIAL_CAPITAL / stockAmount);

        // 計算平均分配後的初始剩餘現金（無法整除的差額）
        let remain = INITIAL_CAPITAL - capital * stockAmount;

        // 根據第一天股價，計算每檔股票可購入的整股數量與更新後剩餘現金
        const holdings = stockDataProcessor.calculateHoldings(indices, capital, remain);

        // 取得更新後的剩餘現金（包含每檔分配後買不完的零錢）
        remain = holdings.remain;

        // 取得持股清單（股票的index 與 股數）
        const holdingList = holdings.holdingList;

        // 計算每一天的投資組合資金水位（持股市值 + 剩餘現金）
        portfolioValues = stockDataProcessor.calculatePortfolioValues(holdingList, remain);

        // 依照資金水位的長度建立對應的標籤
        labels = portfolioValues.map((_, i) => "" + (i + 1));
    } 
    
    // 若未勾選任何股票
    else {
        const stockDataRows = stockDataProcessor.stockDataRows;
        labels = stockDataRows.map((_, i) => "" + (i + 1)); // 直接依照 CSV 行數建立 Day 標籤
        portfolioValues = [];                                   // 未持有資產，資金水位的內容為空
    }

    // 依據標籤與資金水位資料繪製折線圖
    chartCanvas.drawChart(labels, portfolioValues);
}

</script>
</body>
</html>
