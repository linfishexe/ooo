<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles/style.css">
    <title>股價 csv 讀取</title>
</head>
<body>
    <!-- 初始提示與選檔案 -->
    <section id="uploadSection">
        <h2>請選擇要載入的走勢CSV</h2>
        <img src="./upload.svg" alt="uploadCSV">
        <div class="btnBox">
            <button id="loadDefaultBtn">載入預設 CSV</button>
            <label for="csvFile">上傳自己的 CSV</label>
            <input type="file" id="csvFile" accept=".csv" style="display: none;"/>
        </div>
    </section>

    <nav>
        <button onclick="toggleAside(this)" class="menuBtn" aria-label="Toggle Aside Menu">
            <div></div>
            <div></div>
            <div></div>
        </button>
    </nav>
    <main>
        <section>
            <!-- 圖表容器 -->
            <select id="stockSelect" style="display:none;"></select>
            <div id="chartsContainer"></div>
        </section>
        <aside>
            <h2>股票列表</h2>
        </aside>
    </main>
<script>
let globalStockData = null; // 全域保存資料
let currentChart = null;    // 保存目前的 Chart 物件

document.getElementById("csvFile").addEventListener("change", function (event) {
    const file = event.target.files[0];
    if (!file) return;
    Papa.parse(file, { complete: completeParse });
});

document.getElementById("loadDefaultBtn").addEventListener("click", function () {
    const url = "https://linfishexe.github.io/ooo/20210501-20210531.csv";
    fetch(url)
        .then(response => response.text())
        .then(csvText => {
            Papa.parse(csvText, { complete: completeParse });
        })
        .catch(err => console.error("載入預設 CSV 失敗:", err));
});

function completeParse(results) {
    globalStockData = getStockData(results);
    setupStockSelect(globalStockData.stockNames);

    // 隱藏上傳提示
    document.getElementById("uploadSection").style.display = "none";
    // 顯示選單
    document.getElementById("stockSelect").style.display = "block";

    // 預設顯示第一個
    if (globalStockData.stockNames.length > 0) {
        showChartByIndex(0);
    }
}

function getStockData(results) {
    const rows = results.data;

    let stockNames;
    let stockDataRows;

    if (rows[0].length === 1) {
        // 單股 CSV
        stockNames = [rows[0][0]];
        stockDataRows = rows.slice(1).filter(r => r.length > 0 && r[0] !== "");
    } else {
        // 多股 CSV
        stockNames = rows[0];
        stockDataRows = rows.slice(1).filter(r => r.length > 1);
    }

    console.log("stockNames =", stockNames);
    console.log("stockDataRows =", stockDataRows);

    return { stockNames, stockDataRows };
}


// 建立下拉選單
function setupStockSelect(stockNames) {
    const select = document.getElementById("stockSelect");
    select.innerHTML = "";
    stockNames.forEach((name, idx) => {
        const option = document.createElement("option");
        option.value = idx;
        option.textContent = name;
        select.appendChild(option);
    });

    // 綁定事件：切換股票
    select.addEventListener("change", function () {
        const idx = parseInt(this.value);
        showChartByIndex(idx);
    });
}

// 顯示指定股票的圖表
function showChartByIndex(colIndex) {
    const { stockNames, stockDataRows } = globalStockData;
    const stockName = stockNames[colIndex];
    const priceList = extractPriceList(stockDataRows, colIndex);

    const chartsContainer = document.getElementById("chartsContainer");
    chartsContainer.innerHTML = ""; // 清空舊圖表

    const canvas = document.createElement("canvas");
    chartsContainer.appendChild(canvas);

    // 如果已有舊圖表，先銷毀
    if (currentChart) {
        currentChart.destroy();
    }

    currentChart = renderChart(canvas, stockName, priceList);
}

function extractPriceList(stockDataRows, colIndex) {
    return stockDataRows.map(r => parseFloat(r[colIndex]));
}

function renderChart(canvas, stockName, priceList) {
    return new Chart(canvas.getContext("2d"), {
        type: "line",
        data: {
            labels: priceList.map((_, i) => "Day " + (i + 1)),
            datasets: [{
                label: stockName,
                data: priceList,
                borderWidth: 2,
                borderColor: "blue",
                fill: false,
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // 讓圖表滿版
            scales: {
                x: { title: { display: true, text: "天數" } },
                y: { title: { display: true, text: "股價 / 漲跌" } }
            }
        }
    });
}

function toggleAside(button) {
    const aside = document.querySelector("aside");
    button.classList.toggle("open");
    aside.classList.toggle("open");
}

</script>
</body>
</html>
