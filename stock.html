<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./scripts/ChartCanvas.js"></script>
    <script src="./scripts/StockDataProcessor.js"></script>
    <script src="./scripts/StockListUI.js"></script>
    <link rel="stylesheet" href="styles/style.css">
    <title>股價 csv 讀取</title>
</head>
<body>
    <!-- 初始提示與選檔案 -->
    <section id="uploadSection">
        <h2>請選擇要載入的走勢CSV</h2>
        <img src="./upload.svg" alt="uploadCSV">
        <div class="btnBox">
            <button id="loadDefaultBtn">載入預設 CSV</button>
            <label for="csvFile">上傳自己的 CSV</label>
            <input type="file" id="csvFile" accept=".csv" style="display: none;"/>
        </div>
    </section>

    <nav>
        <button onclick="toggleAside(this)" class="menuBtn" aria-label="Toggle Aside Menu">
            <div></div>
            <div></div>
            <div></div>
        </button>
    </nav>

    <main>
        <section>
            <div id="chartsContainer"></div><!-- 圖表容器 -->
            <div id="displayControlContainer">
                <h3>顯示控制</h3>
                <div class="switchBoxContainer">

                    <div class="switchBox active">
                        <div class="switchButton">
                            <div class="switchBall "></div>
                        </div>
                        <span>AAPL</span>
                    </div>

                </div>
            </div>
        </section>
        <aside>
            <h2>股票列表</h2>
            <ul class="stock_list"></ul>
        </aside>
    </main>
<script>
function toggleAside(button) {
    const aside = document.querySelector("aside");
    button.classList.toggle("open");
    aside.classList.toggle("open");
}
</script>
<script>

function gen_SwitchButton(stockName, color){
    const switchBoxDIV = document.createElement("div");
    const switchButtonDIV = document.createElement("div"); 
    const switchBallDIV = document.createElement("div"); 
    const switchBoxSPAN = document.createElement("span");

    switchBoxDIV.classList.add("switchBox");
    switchBoxDIV.classList.add("active");
    switchButtonDIV.classList.add("switchButton");
    switchBallDIV.classList.add("switchBall");
    switchBoxSPAN.textContent = stockName;

    // 套用顏色
    if(color){
        switchBallDIV.style = `--btn-color:${color}`;
        switchButtonDIV.style = `--btn-color:${color}`;
    }

    switchButtonDIV.appendChild(switchBallDIV);
    switchBoxDIV.appendChild(switchButtonDIV);
    switchBoxDIV.appendChild(switchBoxSPAN);
    return switchBoxDIV;
}

const stockList = document.querySelector("aside .stock_list");
const switchBoxContainer = document.querySelector(".switchBoxContainer");

const chartCanvas = new ChartCanvas(chartsContainer);
const stockDataProcessor = new StockDataProcessor();
const stockListUI = new StockListUI(stockList, showChartsByIndices);

document.getElementById("csvFile").addEventListener("change", function (event) {
    const file = event.target.files[0];
    if (!file) return;
    Papa.parse(file, { complete: completeParse });
});

document.getElementById("loadDefaultBtn").addEventListener("click", function () {
    const url = "https://linfishexe.github.io/ooo/20210501-20210531.csv";
    fetch(url)
        .then(response => response.text())
        .then(csvText => { Papa.parse(csvText, { complete: completeParse }); })
        .catch(err => console.error("載入預設 CSV 失敗:", err));
});

function completeParse(results) {
    stockDataProcessor.parse(results);
    stockListUI.render(stockDataProcessor.stockNames);
    document.getElementById("uploadSection").style.display = "none";
}

function showChartsByIndices(indices) {
    const stockNames = stockDataProcessor.stockNames;
    const INITIAL_CAPITAL = 10000000;
    let labels = [];
    let datasets = [];

    switchBoxContainer.replaceChildren();

    if (indices.length > 0) {
        // ====== 平均分配買全部股票 ======
        const capital = Math.floor(INITIAL_CAPITAL / indices.length);
        let remain = INITIAL_CAPITAL - capital * indices.length;
        const holdings = stockDataProcessor.calcHoldings(indices, capital, remain);
        remain = holdings.remain;
        const holdingList = holdings.holdingList;
        const portfolioValues = stockDataProcessor.calcValues(holdingList, remain);
        labels = portfolioValues.map((_, i) => "" + (i + 1));

        if(indices.length > 1){
            datasets.push({
                label: "平均分配全部股票",
                data: portfolioValues,
                borderColor: "#2b5fce",
                fill: false
            });

            // 建立控制按鈕
            const switchBoxAll = gen_SwitchButton("平均分配全部股票", "#2b5fce");
            bindSwitchToDataset(switchBoxAll, "平均分配全部股票");
            switchBoxContainer.appendChild(switchBoxAll);
        }

        // ====== 全部資金只買單一股票 ======
        indices.forEach((stockIndex, idx) => {
            const holdingsSingle = stockDataProcessor.calcHoldings([stockIndex], INITIAL_CAPITAL, 0);
            const remainSingle = holdingsSingle.remain;
            const holdingListSingle = holdingsSingle.holdingList;
            const valuesSingle = stockDataProcessor.calcValues(holdingListSingle, remainSingle);

            const label = stockDataProcessor.stockNames[stockIndex];
            const color = getColor(idx);
            datasets.push({
                label: label,
                data: valuesSingle,
                borderColor: color,
                fill: false
            });

            
            const switchBox = gen_SwitchButton(label, color);
            bindSwitchToDataset(switchBox, label);
            switchBoxContainer.appendChild(switchBox);
        });
    
    } else {
        const stockDataRows = stockDataProcessor.stockDataRows;
        labels = stockDataRows.map((_, i) => "" + (i + 1));
    }

    chartCanvas.drawChart(labels, datasets);
}

function bindSwitchToDataset(switchBox, datasetLabel) {
    switchBox.addEventListener("click", () => {
        const chart = chartCanvas.chart;
        const datasetIndex = chart.data.datasets.findIndex(ds => ds.label === datasetLabel);
        if (datasetIndex !== -1) {
            const meta = chart.getDatasetMeta(datasetIndex);
            meta.hidden = !meta.hidden; // 切換顯示/隱藏
            chart.update();
        }
        switchBox.classList.toggle("active");
    });
}

function getColor(i) {
    const colors = ["#a99391", "#bc9683","#c49d62", "#8ea98e", "#787e82", "#6a5f7d", "#71494a"];
    return colors[i % colors.length];
}

</script>
</body>
</html>
